# Домашнее задание 2

С расширением аудитории Zwitter, с развитием функционала социальной сети Zwitter, расширились требования и пожелания 
основателей стартапа. Теперь основатели-стартапщики хотят получать заранее вычисленную информацию о конкретных 
пользователях социальной сети, при этом, необходимое требование, чтобы запросы выполнялись максмально быстро.
 
## Что надо делать?

Во втором домашнем задании вам необходимо помочь основателями решить следующие задачи:
 
  * настроить ежедневный расчет метрик для всех пользователей социальной сети по уже собираемым логам в HDFS,
  * настроить сохранение расcчитанных метрик в таблицы HBase,
  * предоставить доступ к данным, хранящимся в HBase, через HTTP API.

Ниже вы можете найти более подробную информацию по следующим вопросам:

  * [Исходные данные](#Исходные-данные)
  * [Рассчитываемые метрики](#Рассчитываемые-метрики)
  * [Требования](#Требования)
  * [Критерии сдачи задания](#Критерии-сдачи-задания)
  * [Процесс сдачи задания](#Процесс-сдачи-задания)
  * [Спецификация HTTP API](#Спецификация-http-api)
  * [Дополнительные комментарии](#Дополнительные-комментарии)


## Исходные данные

В этом задании используются те же исходные данные, что и в первом домашнем задании: логи доступа к веб-серверу.

Из каждой записи в логе можно выделить **пользователя** и **посещенный профиль**: пользователь определяется IP-адресом,
а посещенный профиль -- идентификатором, закодированном в URI запроса в виде `idNNNNN`.

К примеру, по записи

```
195.206.123.39 - - [24/Sep/2015:12:32:53 +0400] "GET /id18222 HTTP/1.1" 200 10703 "http://bing.com/" "Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.94 Safari/537.36"
```

Можно сказать, что пользователь **195.206.123.39** посетил профиль **id18222**.

Как и в первом домашнии задании, для расчета целевых метрик вам стоит рассматривать только успешные (HTTP-код 200)
запросы к веб-сайту. Неуспешные запросы стоит игнорировать.

## Рассчитываемые метрики

Вам необходимо посчитать набор метрик для каждого пользователя социальной сети, для каждого профиля социальной сети,
а также перекрестную метрику по пользователям и профилям.

Метрики по пользователям:

  * `user_hits` -- суммарное количество запросов определенного пользователя к веб-сайту (по часам),
  * `user_visited_profiles` -- множество просмотренных данным пользователем профилей в порядке убывания количества просмотров (при совпадении количества просмотров -- упорядочить профили лексикографически) (по дням).

Метрики по профилям:

  * `profile_hits` -- суммарное количество просмотров определенного профиля всеми пользователями веб-сайта (по часам),
  * `profile_users` -- суммарное количество уникальных пользователей, просматривавших данный профиль (по дням).

Перекрестные метрики:

  * `user_profile_hits` -- суммарное количество посещений определенным пользователем определенного профиля (за день).

## Требования

Ваше решение должно удовлетворять следующим требованиям:

  * вычисленные метрики должны располагаться в таблицах вида `bigdatashad_USER_TABLENAME`, где `USER` -- ваш логин, `TABLENAME` -- выбранное вами имя таблицы;
  * построенные таблицы не должны содержать более 100 стоблцов;
  * вычисление метрик для выполнения запросов должно происходить в процессе выполнения MR-задач
    (если вы пишете на Python, то можете использовать библиотеку HappyBase; если вы пишете на Java -- то нативную библиотеку HBase).
  * вычисленные данные должны быть готовы к 9 утра следующего дня (к примеру, результаты за 25.09
    должны быть готовы к 09:00 26.09); готовность вычисленных данных определяется возможностью выполнения запросов через HTTP API;
  * время ответа HTTP API не должно превышать 5 секунд;
  * ваш процесс расчета и обновления данных в HBase должен стабильно работать начиная с момента сдачи задания
    и до окончания курса, при этом ваше решение _не должно_ терять просчитанные данные за
    прошедшие дни (в том числе и после удаления исходных данных из HDFS).

## Критерии сдачи задания

Задание засчитывается как сданное, если:

  * до **16-го ноября** реализован HTTP API отвечающий хотя бы на _один_ запрос из указанных типов;
  * в период **с 16 ноября по 30 ноября** ваше решение выдает по HTTP API корректные данные за период
    с 9 ноября;

Дополнительных попугаев в этом задании можно заработать следующими способами:

  * если вы реализуете HTTP API отвечающий на все запросы из указанных типов, то получаете еще одного попугая;
  * если ваше решение корректно работает в течение 45 дней, то вы получаете одного попугая;
  * суммарно за это задание можно получить не более трех дополнительных попугаев.

## Процесс сдачи задания

Для самопроверки и сдачи вашего решения вам необходимо будет использовать веб-интерфейс Zwitter,
доступный на порту `8888` машины `hadoop2-00.yandex.ru` (NB: для доступа к веб-интерфейсу
вам необходимо пробросить `8888`-й порт на локальную машину, аналогично веб-интерфейсу Hadoop).

Для самопроверки вы можете использовать страницу по адресу `http://hadoop2-00.yandex.ru:8888/ysda/hw2/playground`, где
вы можете указать порт, на котором работает ваше HTTP API, и диапазон дат.
При нажатии на кнопку "Query" будет выполнен запрос к вашему решению, проверена корректность ответа
(структура ответа и типы возвращаемых значений), и произведена отрисовка ответа.

Используя данный интерфейс вы можете проверить, что ваше решение корректно интегрируется в систему.

## Спецификация HTTP API

Ваше решение должно уметь отвечать на множество запросов типа `GET` по URI `/api/hw2/XXX`,
соответствующие вычисляемым метрикам. Если вы умеете вычислять запрашиваемую метрику,
то ваше решение должно отвечать с HTTP-кодом 200; в качестве ответа должен быть JSON-документ
с указанной в описании запроса структурой. Если вы не умеете вычислять запрашиваемую метрику,
то ваше решение должно отвечать с HTTP-кодом 404.

### `/api/hw2/user_hits`

Параметры запроса:
  * `start_date` -- начальная дата в формате `YYYY-MM-DD`,
  * `end_date` -- конечная дата в формате `YYYY-MM-DD`,
  * `user_ip` -- IP-адрес пользователя в формате `A.B.C.D`.

Формат ответа:
  * Ключами JSON-документа ответа являются временные метки в указанном временном диапазоне.
    Для данной метрики временная гранулярность часовая; метки имеют вид `YYYY-MM-DDTHH:mm`, например:
    `2015-10-01T10:00`, `2015-10-01T11:00` и т. д.
  * Значениями JSON-документа ответа являются числа, определяющие количество хитов данного пользователя
    в данный временной интервал.
  * Если у вас нету значения за какие-либо временные интервалы, то используйте
    `null`.

Пример запроса:

```
GET /api/hw2/user_hits?start_date=2015-10-01&end_date=2015-10-01&user_ip=81.221.37.3
```

Пример ответа:

```json
{
  "2015-10-01T00:00": 10,
  "2015-10-01T01:00": 14,
  "2015-10-01T02:00": 9,
  "2015-10-01T03:00": 1,
  "2015-10-01T04:00": 0,
  "2015-10-01T05:00": 0,
  "2015-10-01T06:00": 0,
  "2015-10-01T07:00": null,
  ...
  "2015-10-01T23:00": null
}
```

### `/api/hw2/user_visited_profiles`

Параметры запроса:
  * `start_date` -- начальная дата в формате `YYYY-MM-DD`,
  * `end_date` -- конечная дата в формате `YYYY-MM-DD`,
  * `user_ip` -- IP-адрес пользователя в формате `A.B.C.D`.

Формат ответа:
  * Ключами JSON-документа ответа являются временные метки в указанном временном диапазоне.
    Для данной метрики временная гранулярность дневная; метки имеют вид `YYYY-MM-DD`, например:
    `2015-10-01`, `2015-10-02` и т. д.
  * Значениями JSON-документа ответа являются массивы, кодирующие набор посещенных данных пользователем
    в данный временной интервал профилей в порядке убывания частоты (при одинаковой частоте упорядочить профили лексикографически).
    Каждый профиль кодируется как `idNNNNN`.
  * Если у вас нету значения за какие-либо временные интервалы, то используйте `null` в качестве ответа.

Пример запроса:

```
GET /api/hw2/user_visited_profiles?start_date=2015-10-01&end_date=2015-10-05&user_ip=81.221.37.3
```

Пример ответа:

```json
{
  "2015-10-01": ["id10001", "id10002", "id10003"],
  "2015-10-02": ["id10003"],
  "2015-10-03": [],
  "2015-10-04": [],
  "2015-10-05": null
}
```

### `/api/hw2/profile_hits`

Параметры запроса:
  * `start_date` -- начальная дата в формате `YYYY-MM-DD`,
  * `end_date` -- конечная дата в формате `YYYY-MM-DD`,
  * `profile_id` -- идентификатор профиля в формате `idNNNNN`.

Формат ответа:
  * Ключами JSON-документа ответа являются временные метки в указанном временном диапазоне.
    Для данной метрики временная гранулярность часовая; метки имеют вид `YYYY-MM-DDTHH:mm`, например:
    `2015-10-01T10:00`, `2015-10-01T11:00` и т. д. (часы в сутках нумеруются от `00` до `23`).
  * Значениями JSON-документа ответа являются числа, определяющие количество посещений данного профиля
    всеми пользователями социальной сети в данный временной интервал.
  * Если у вас нету значения за какие-либо временные интервалы, то используйте
    `null`.

Пример запроса:

```
GET /api/hw2/profile_hits?start_date=2015-10-01&end_date=2015-10-01&profile_id=id10001
```

Пример ответа:

```json
{
  "2015-10-01T00:00": 10,
  "2015-10-01T01:00": 14,
  "2015-10-01T02:00": 9,
  "2015-10-01T03:00": 1,
  "2015-10-01T04:00": 0,
  "2015-10-01T05:00": 0,
  "2015-10-01T06:00": 0,
  "2015-10-01T07:00": null,
  ...
  "2015-10-01T23:00": null
}
```

### `/api/hw2/profile_users`

Параметры запроса:
  * `start_date` -- начальная дата в формате `YYYY-MM-DD`,
  * `end_date` -- конечная дата в формате `YYYY-MM-DD`,
  * `profile_id` -- идентификатор профиля в формате `idNNNNN`.

Формат ответа:
  * Ключами JSON-документа ответа являются временные метки в указанном временном диапазоне.
    Для данной метрики временная гранулярность дневная; метки имеют вид `YYYY-MM-DD`, например:
    `2015-10-01`, `2015-10-02` и т. д.
  * Значениями JSON-документа ответа являются числа, определяющие количество уникальных пользователей, посетивших
    данныйы профиль социальной сети в данный временной интервал.
  * Если у вас нету значения за какие-либо временные интервалы, то используйте
    `null`.

Пример запроса:

```
GET /api/hw2/profile_users?start_date=2015-10-01&end_date=2015-10-05&profile_id=id10001
```

Пример ответа:

```json
{
  "2015-10-01": 100,
  "2015-10-02": 200,
  "2015-10-03": 100,
  "2015-10-04": 0,
  "2015-10-05": null
}
```

### `/api/hw2/user_profile_hits`

Параметры запроса:
  * `start_date` -- начальная дата в формате `YYYY-MM-DD`,
  * `end_date` -- конечная дата в формате `YYYY-MM-DD`,
  * `user_ip` -- IP-адрес пользователя в формате `A.B.C.D`,
  * `profile_id` -- идентификатор профиля в формате `idNNNNN`.

Формат ответа:
  * Ключами JSON-документа ответа являются временные метки в указанном временном диапазоне.
    Для данной метрики временная гранулярность дневная; метки имеют вид `YYYY-MM-DD`, например:
    `2015-10-01`, `2015-10-02` и т. д.
  * Значениями JSON-документа ответа являются числа, определяющие количество посещений данным пользователем
    данного профиля социальной сети в данный временной интервал.
  * Если у вас нету значения за какие-либо временные интервалы, то используйте
    `null`.

Пример запроса:

```
GET /api/hw2/user_profile_hits?start_date=2015-10-01&end_date=2015-10-05&user_ip=81.221.37.3&profile_id=id10001
```

Пример ответа:

```json
{
  "2015-10-01": 10,
  "2015-10-02": 20,
  "2015-10-03": 10,
  "2015-10-04": 0,
  "2015-10-05": null
}
```

Для быстрого старта вы можете воспользоваться доступным [шаблоном HTTP API](./example.py).

## Дополнительные комментарии

  * Продумайте количество и схему таблиц HBase, которые вы планируете использовать. В этом вам могут помочь материалы [HBaseCon 2012 | HBase Schema Design](http://www.cloudera.com/content/www/en-us/resources/hbasecon/video-hbasecon-2012-hbasecon-2012.html), а также [Introduction to HBase Schema Design](http://0b4af6cdc2f0c5998459-c0245c5c937c5dedcca3f1764ecc9b2f.r43.cf2.rackcdn.com/9353-login1210_khurana.pdf).
